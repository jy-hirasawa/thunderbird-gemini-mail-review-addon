# 安全政策

[English](../en/SECURITY.md) | [日本語](../ja/SECURITY.md) | [Deutsch](../de/SECURITY.md) | [Français](../fr/SECURITY.md) | 简体中文

## 数据存储和隐私

此插件将以下数据本地存储在 Thunderbird 的 browser.storage.local 中：

### 存储的数据

1. **API 密钥**（`geminiApiKeyEncrypted`）
   - 您的 Google Gemini API 密钥
   - **使用 AES-GCM 和特定于配置文件的密钥加密**（v1.1 中的新功能）
   - 特定于配置文件的密钥使用 PBKDF2 以 100,000 次迭代派生
   - 加密密钥基于浏览器运行时 ID 和随机盐
   - 除了发送到 Google 的 Gemini API 外，从不传输到任何服务器
   - 旧版未加密密钥在下次保存时自动迁移

2. **API 端点**（`geminiApiEndpoint`）
   - Gemini API 端点 URL
   - 以纯文本存储（非敏感）
   - 经过验证以确保 HTTPS 协议和仅限 Google 域
   - 防止 SSRF 攻击

3. **自定义提示模板**（`customPromptTemplatesEncrypted`）
   - 最多 3 个带有名称和内容的自定义提示模板
   - **使用 AES-GCM 和特定于配置文件的密钥加密**（v1.1 中的新功能）
   - 与 API 密钥相同的加密密钥
   - 经过清理以防止提示注入攻击
   - 名称限制为 100 个字符，内容限制为 5000 个字符
   - 旧版未加密模板在下次保存时自动迁移

4. **电子邮件缓存**（`geminiCache`）
   - 缓存的分析结果包括：
     - 电子邮件主题（已清理）
     - 电子邮件收件人（已清理）
     - 电子邮件正文内容（已清理，最多 10,000 个字符）
     - AI 分析响应
     - 时间戳
     - 使用的自定义提示
   - **每个缓存条目使用 AES-GCM 加密，使用电子邮件 ID 作为密钥**（v1.1 中的新功能）
   - 电子邮件 ID 是电子邮件内容的 SHA-256 哈希（主题 + 收件人 + 正文）
   - 加密确保缓存的数据与特定电子邮件内容绑定
   - 限制为 50 个最新条目
   - 根据缓存保留设置自动过期（默认：7 天）
   - 可以通过设置手动清除

5. **最后检查的哈希**（`lastCheckedHashes`）
   - 最近检查的电子邮件的 SHA-256 哈希，用于更改检测
   - 限制为 20 个最新条目
   - 仅存储哈希值，不存储实际内容
   - 未加密（已经过哈希处理）

6. **配置文件加密盐**（`profileEncryptionSalt`）
   - 用于密钥派生的随机 16 字节盐
   - 每个配置文件生成一次
   - 存储为 base64 字符串
   - 用于派生特定于配置文件的加密密钥

## 加密实现

### 加密算法

- **算法**：AES-GCM（高级加密标准 - 伽罗瓦/计数器模式）
- **密钥大小**：256 位
- **IV 大小**：12 字节（96 位），为每次加密随机生成
- **身份验证**：AES-GCM 内置身份验证标签

### 密钥派生

1. **特定于配置文件的密钥**（用于设置）：
   - 使用 PBKDF2 和 SHA-256 派生
   - 迭代：100,000（为敏感 API 密钥提供高安全性）
   - 盐：随机 16 字节盐，每个配置文件唯一
   - 基础材料：浏览器运行时 ID（每个安装/配置文件唯一）

2. **特定于电子邮件的密钥**（用于缓存）：
   - 使用 PBKDF2 和 SHA-256 派生
   - 迭代：10,000（为性能降低，仍然安全）
   - 盐：固定字符串以保持一致性
   - 基础材料：电子邮件 ID（电子邮件内容的 SHA-256 哈希）

### 向后兼容性

- 自动检测并解密旧版未加密数据
- 在下次保存时迁移到加密格式
- 迁移期间不会丢失数据

## 安全措施

### 加密优势

1. **增强的数据保护**
   - API 密钥和自定义提示不再以纯文本存储
   - 缓存的电子邮件内容使用特定于电子邮件的密钥加密
   - 防止未经授权访问配置文件目录

2. **特定于配置文件的加密**
   - 每个 Thunderbird 配置文件都有自己的加密密钥
   - 在一个配置文件中加密的数据无法在另一个配置文件中解密
   - 提供不同安装之间的隔离

3. **特定于电子邮件的缓存加密**
   - 每封缓存的电子邮件都使用从其内容派生的密钥加密
   - 即使有人访问缓存，他们也需要电子邮件内容才能解密
   - 为缓存数据提供额外的安全层

### 输入验证和清理

1. **API 端点验证**
   - 必须使用 HTTPS 协议
   - 不能是 localhost 或私有 IP 地址
   - 必须是 Google API 域（googleapis.com）

2. **内容清理**
   - 在发送到 API 之前清理电子邮件内容
   - 删除常见的提示注入模式
   - 将内容长度限制为 10,000 个字符
   - 删除 Markdown 代码块和指令标签
   - 删除 AI 越狱模式（例如"忽略之前的指令"）

3. **自定义提示清理**
   - 限制为 5,000 个字符
   - 删除提示注入模式
   - 模板名称限制为 100 个字符

4. **XSS 防护**
   - 使用 `textContent` 显示分析结果（而非 `innerHTML`）
   - 不渲染用户生成的 HTML

### 缓存安全

1. **加密**（v1.1 中的新功能）
   - 每个缓存条目使用 AES-GCM 加密，使用电子邮件 ID 作为密钥
   - 电子邮件 ID 从电子邮件内容派生（SHA-256 哈希）
   - 为缓存数据提供特定于内容的加密

2. **自动过期**
   - 缓存数据在配置的保留期后自动过期
   - 默认保留：7 天（可配置 1-365 天）
   - 过期条目自动清理

3. **手动清除缓存**
   - 用户可以通过设置手动清除所有缓存数据
   - 包括确认对话框以防止意外删除

4. **大小限制**
   - 缓存限制为 50 个最新条目
   - 达到限制时自动删除最旧的条目

## 隐私考虑

### 数据传输

- 电子邮件内容被传输到 Google 的 Gemini API 进行分析
- 数据通过 HTTPS 发送
- 受 [Google 隐私政策](https://policies.google.com/privacy)约束

### 数据存储

- 所有数据都本地存储在 Thunderbird 的配置文件目录中
- 除了 Google 的 Gemini API 外，不会将数据传输给第三方
- **API 密钥和自定义提示现已加密**（v1.1 中的新功能）
- **缓存的电子邮件数据现已加密**（v1.1 中的新功能）
- 加密密钥从特定于配置文件和电子邮件的标识符派生

### 对敏感电子邮件的建议

对于包含敏感或机密信息的电子邮件：

1. **定期清除缓存**
   - 使用设置中的"清除所有缓存数据"按钮
   - 考虑在处理敏感电子邮件后清除缓存

2. **减少缓存保留**
   - 对于敏感工作，将缓存保留设置为 1 天
   - 在设置 → 缓存保留天数中配置

3. **禁用缓存**（手动方法）
   - 在每次使用前后清除缓存
   - 注意：这将需要为每次电子邮件检查进行 API 调用

4. **查看隐私政策**
   - 了解电子邮件内容会发送到 Google 的 AI 服务
   - 查看 Google 的数据处理实践

5. **考虑不使用该插件**
   - 对于高度机密的电子邮件，考虑不使用 AI 审查
   - 改为依赖手动审查

## 报告安全漏洞

如果您在此插件中发现安全漏洞，请通过以下方式报告：

1. 使用 `security` 标签打开 GitHub issue
2. 提供有关漏洞的详细信息
3. 在漏洞得到解决之前不要公开披露

## 限制

### 浏览器存储安全

- **现已实现加密**（v1.1 中的新功能）
  - API 密钥和自定义提示使用 AES-GCM 加密
  - 缓存的电子邮件数据使用特定于电子邮件的密钥加密
  - 加密密钥从配置文件和电子邮件标识符派生
- 但是，加密密钥是从运行时标识符派生的
  - 有权访问您的 Thunderbird 配置文件的人仍可能访问数据
  - 加密提供额外保护，但不是端到端加密
- 具有存储权限的其他插件仍可访问浏览器存储

### 加密限制

- **密钥派生**：加密密钥从浏览器运行时 ID 和盐派生
  - 不如用户提供的密码强
  - 提供对配置文件目录的偶然访问的保护
  - 不能防止具有完全系统访问权限的坚定攻击者

- **无主密码**：与密码管理器不同，没有主密码
  - 在可用性和安全性之间进行权衡
  - 用户不需要每次都输入密码
  - 但加密是自动且透明的

### 无端到端加密

- 电子邮件内容被传输到 Google 的服务器
- 内容不是端到端加密的（除了传输中的 HTTPS）
- Google 可能根据其隐私政策处理和分析数据

### 本地系统安全

- 安全性取决于您本地系统的安全性
- 恶意软件或对您计算机的未经授权访问可能会暴露存储的数据
- 使用最新的防病毒软件和安全补丁保持系统安全
- 使用磁盘加密以获得额外保护

## 最佳实践

1. **API 密钥管理**
   - 像对待密码一样对待您的 API 密钥
   - 不要分享您的 API 密钥
   - 定期轮换您的 API 密钥
   - 在 Google Cloud Console 中使用 API 密钥限制

2. **系统安全**
   - 保持 Thunderbird 更新
   - 保持操作系统更新
   - 为您的用户账户使用强密码/加密
   - 如果处理敏感数据，启用磁盘加密

3. **缓存管理**
   - 定期清除敏感电子邮件的缓存
   - 根据您的安全需求调整保留期
   - 监控正在缓存的数据

4. **隐私意识**
   - 了解 AI 服务会处理您的数据
   - 定期查看 Google 的隐私政策
   - 注意您提交进行分析的内容

## 更新和维护

- 安全改进正在进行中
- 定期检查更新
- 查看更改日志以了解与安全相关的修复
- 通过 GitHub issues 报告任何安全问题
